<html>
<head>
<script src="https://www.gstatic.com/firebasejs/5.5.9/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/5.5.9/firebase-auth.js"></script>

<script src="https://cdn.firebase.com/libs/firebaseui/3.4.1/firebaseui.js"></script>
<link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/3.4.1/firebaseui.css" />

<script type="text/javascript">

  var config = {
    apiKey: "AIzaSyDH79sRbyZFIPa_OrAScjwqV28M7YGaoow",
    authDomain: "dyndex-test.firebaseapp.com",
    projectId: "dyndex-test"
  };
  let app = firebase.initializeApp(config);
  firebase.auth(app).setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  // .then(()=>{
  //   firebase.auth(app).onAuthStateChanged(function(user) {
  //     if (!user)
  //       return;
  //     //console.log(`currentUser ${user.uid} email ${user.email}`);
  //     window.location.assign('/');
  //   });
  // });

  // from https://stackoverflow.com/questions/30106476/using-javascripts-atob-to-decode-base64-doesnt-properly-decode-utf-8-strings
  function b64DecodeUnicode(str) {
    return decodeURIComponent(atob(str).split('').map(function(c) {
      return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
  }

  function expiryDateFromJwt(token) {
    let decoded;
    try {
      decoded = JSON.parse(b64DecodeUnicode(token.split('.')[1]));
    } catch(e) {
    }
    let exp = decoded && decoded.exp;
    return exp && new Date(exp*1000);
  };

  var uiConfig = {
    signInSuccessUrl: '/',
    callbacks: {
      signInSuccessWithAuthResult: function(authResult, redirectUrl) {
        let isNewUser = authResult.additionalUserInfo.isNewUser;
        if (isNewUser) {
          alert('Thankyou for signing up. Please contact us to confirm your account');
        } else {
          let secure = window.location.protocol=='https:' || (window.location.hostname!=='localhost' && window.location.hostname!=='127.0.0.1' && window.location.hostname!=='0.0.0.0');
          authResult.user.getIdToken().then((token)=>{
            let expDate = expiryDateFromJwt(token);
            let cookies = `__session=${token}; samesite=strict; path=/${expDate ? '; expires='+expDate.toUTCString() : ''}${secure ? '; secure' : ''}`;
            document.cookie = cookies;
            window.location.assign('/');
          });
        }
        return false;
      }
    },
    signInOptions: [
      // Leave the lines as is for the providers you want to offer your users.
      // firebase.auth.GoogleAuthProvider.PROVIDER_ID,
      // firebase.auth.FacebookAuthProvider.PROVIDER_ID,
      // firebase.auth.TwitterAuthProvider.PROVIDER_ID,
      // firebase.auth.GithubAuthProvider.PROVIDER_ID,
      firebase.auth.EmailAuthProvider.PROVIDER_ID,
      // firebase.auth.PhoneAuthProvider.PROVIDER_ID,
      // firebaseui.auth.AnonymousAuthProvider.PROVIDER_ID
    ],
    credentialHelper: firebaseui.auth.CredentialHelper.NONE,
    // tosUrl and privacyPolicyUrl accept either url string or a callback
    // function.
    // Terms of service url/callback.
    tosUrl: '/terms-of-use.html',
    // Privacy policy url/callback.
    privacyPolicyUrl: function() {
      window.location.assign('/privacy-policy.html');
    }
  };

  // Initialize the FirebaseUI Widget using Firebase.
  var ui = new firebaseui.auth.AuthUI(app.auth());
  // The start method will wait until the DOM is loaded.
  ui.start('#firebaseui-auth-container', uiConfig);
</script>

</head>
<body>
  <div id="firebaseui-auth-container"></div>
</body>
</html>

